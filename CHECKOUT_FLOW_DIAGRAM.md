# Checkout Flow Diagram

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚
â”‚ (Mobile App)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ POST /api/cart/checkout
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      API Server                          â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         Checkout Endpoint (Synchronous)            â”‚ â”‚
â”‚  â”‚                                                     â”‚ â”‚
â”‚  â”‚  1. Check Wallet Balance                           â”‚ â”‚
â”‚  â”‚  2. Deduct Payment                                 â”‚ â”‚
â”‚  â”‚  3. Create Purchase Transaction                    â”‚ â”‚
â”‚  â”‚  4. Clear Cart                                     â”‚ â”‚
â”‚  â”‚  5. Update Delivery Address                        â”‚ â”‚
â”‚  â”‚  6. Enqueue Background Job â”€â”€â”                     â”‚ â”‚
â”‚  â”‚  7. Return Response           â”‚                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                  â”‚                        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Response (~150ms)         â”‚
       â–¼                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚   Client    â”‚                    â”‚
â”‚  (Success)  â”‚                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
                                   â”‚ Job Data
                                   â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   Redis Queue    â”‚
                        â”‚   (Bull Queue)   â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ Next Job
                                 â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚    Background Worker        â”‚
                   â”‚  (checkoutWorker.js)        â”‚
                   â”‚                             â”‚
                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                   â”‚  â”‚  Job Processor        â”‚ â”‚
                   â”‚  â”‚                       â”‚ â”‚
                   â”‚  â”‚  1. Upgrade Levels    â”‚ â”‚
                   â”‚  â”‚  2. Distribute Points â”‚ â”‚
                   â”‚  â”‚  3. Create Txns       â”‚ â”‚
                   â”‚  â”‚  4. Update Record     â”‚ â”‚
                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                   â”‚                             â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ All Updates
                                 â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚   MongoDB    â”‚
                          â”‚  (Database)  â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Detailed Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CHECKOUT REQUEST FLOW                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Time: 0ms
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Client â†’ API: POST /api/cart/checkout
              {
                "deliveryAddress": "123 Main St"
              }

Time: 10ms - 150ms (SYNCHRONOUS PHASE)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
API Server:
  â”œâ”€ [10ms]  Find cart
  â”œâ”€ [20ms]  Get customer
  â”œâ”€ [30ms]  Validate wallet balance
  â”œâ”€ [50ms]  Deduct payment (customer.points -= total)
  â”œâ”€ [70ms]  Calculate reward points
  â”œâ”€ [90ms]  Create purchase transaction
  â”œâ”€ [110ms] Clear cart
  â”œâ”€ [130ms] Update delivery address
  â””â”€ [140ms] Enqueue background job â†’â†’â†’ Redis Queue

Time: 150ms
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
API â†’ Client: HTTP 200 OK
              {
                "success": true,
                "transactionId": "xyz...",
                "newWalletBalance": 5000,
                "rewards": { "status": "processing" }
              }

âœ… USER SEES SUCCESS MESSAGE
   Cart is cleared, points deducted, order confirmed!

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Time: 200ms - 700ms (ASYNCHRONOUS PHASE)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Background Worker (Separate Process):
  â”œâ”€ [200ms] ğŸ“¥ Pick job from queue
  â”œâ”€ [250ms] ğŸ”„ Upgrade tree levels
  â”‚          â””â”€ Check referrals â†’ Update levelLetter
  â”‚
  â”œâ”€ [350ms] ğŸ’° Distribute tree points
  â”‚          â”œâ”€ Find parent chain
  â”‚          â”œâ”€ Level A: +5 points
  â”‚          â”œâ”€ Level B: +5 points
  â”‚          â”œâ”€ Level C: +5 points
  â”‚          â”œâ”€ ...
  â”‚          â””â”€ Level J: +2.5 points (shared with 2 users)
  â”‚
  â”œâ”€ [550ms] ğŸ“ Create transactions
  â”‚          â”œâ”€ tree_reward (Level A)
  â”‚          â”œâ”€ tree_reward (Level B)
  â”‚          â”œâ”€ tree_reward_shared (Level J)
  â”‚          â”œâ”€ gifts_reward
  â”‚          â””â”€ app_reward
  â”‚
  â””â”€ [700ms] âœ… Update checkout transaction
             â””â”€ Save treeDistribution log

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Total User Wait Time: 150ms (vs 600ms before)
Total Processing Time: 700ms (but non-blocking!)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

## Database Operations Timeline

```
BEFORE RESPONSE (Blocking - Client Waits)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[20ms]  â–º Read: Customer (wallet check)
[50ms]  â–º Write: Customer (deduct points)
[90ms]  â–º Write: Transaction (purchase)
[110ms] â–º Write: Cart (clear)
[130ms] â–º Write: Customer (address)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total: 5 operations in ~130ms âœ… Fast!

AFTER RESPONSE (Non-Blocking - Client Happy)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[250ms] â–º Read: Customers (tree parents) Ã— 10
[350ms] â–º Write: Customer (level upgrades) Ã— 10
[450ms] â–º Write: Customer (point rewards) Ã— 10
[550ms] â–º Write: Transaction (rewards) Ã— 13
[700ms] â–º Write: Transaction (final update)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total: 44 operations in ~500ms âš¡ Background!
```

## Component Interaction

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client     â”‚ Makes checkout request
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CartController      â”‚ Handles HTTP request
â”‚  (checkout endpoint) â”‚ Validates & processes synchronous steps
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                 â”‚
       â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MongoDB     â”‚    â”‚ Redis Queue â”‚
â”‚              â”‚    â”‚ (Bull)      â”‚
â”‚ - Customer   â”‚    â”‚             â”‚
â”‚ - Transactionâ”‚    â”‚ Job Data:   â”‚
â”‚ - Cart       â”‚    â”‚ - customerIdâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ - amounts   â”‚
                    â”‚ - txnId     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ Worker polls queue
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ CheckoutWorker   â”‚
                    â”‚ (background)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Processor        â”‚
                    â”‚ - upgradeTreeLvl â”‚
                    â”‚ - distributePts  â”‚
                    â”‚ - createTxns     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  MongoDB     â”‚
                    â”‚              â”‚
                    â”‚ Updates:     â”‚
                    â”‚ - Customer   â”‚
                    â”‚ - Transactionâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Reward Distribution Tree Example

```
                        ğŸ‘¤ Buyer
                        Level: A
                        Reward: 0 points
                            â”‚
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚               â”‚
                ğŸ‘¤ Parent       ğŸ‘¤ Others
                Level: B          
                Reward: 5% = 1.75 points
                    â”‚
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
    ğŸ‘¤ Grandparent          ğŸ‘¤ Others
    Level: C
    Reward: 5% = 1.75 points
        â”‚
        â‹®
        â”‚
    ğŸ‘¤ Level J User 1
    ğŸ‘¤ Level J User 2      } Share 5% = 0.875 pts each
    ğŸ‘¤ Level J User 3      } (1.75 / 2 users)

Total Tree Pool: 35% = 35 points
Each Level (A-I): 5% = 1.75 points
Level J Bucket: 5% = 1.75 points (shared)
Unused Levels: â†’ Added to Gifts Pool
```

## Error Handling Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Background Job Starts                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Try... â”‚
        â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
            â”‚
            â”œâ”€ Success â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Job Complete âœ…
            â”‚
            â”œâ”€ Error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Log Error
            â”‚                       â”‚
            â”‚                       â–¼
            â”‚                   Retry #1
            â”‚                       â”‚
            â”‚                       â”œâ”€ Success â”€â”€â–º Complete âœ…
            â”‚                       â”‚
            â”‚                       â”œâ”€ Error â”€â”€â”€â”€â–º Retry #2
            â”‚                       â”‚               â”‚
            â”‚                       â”‚               â”œâ”€ Success â”€â–º Complete âœ…
            â”‚                       â”‚               â”‚
            â”‚                       â”‚               â””â”€ Error â”€â”€â”€â–º Retry #3
            â”‚                       â”‚                              â”‚
            â”‚                       â”‚                              â”œâ”€ Success â”€â–º Complete âœ…
            â”‚                       â”‚                              â”‚
            â”‚                       â”‚                              â””â”€ Error â”€â”€â–º FAILED âŒ
            â”‚                       â”‚                                          (Logged)
            â”‚                       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Scaling Strategy

```
Single Worker Setup (Development)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Redis  â”‚â—„â”€â”€â”€â”€â”€â”¤ Worker â”‚
â”‚  Queue  â”‚      â”‚   #1   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  Jobs: 10        Processing: 1
  Wait: Short     Load: Low âœ…


Multiple Workers (Production)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Redis  â”‚â—„â”€â”€â”€â”€â”€â”¤ Worker â”‚
â”‚  Queue  â”‚      â”‚   #1   â”‚
â”‚         â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  Jobs:  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   100   â”‚â—„â”€â”€â”€â”€â”€â”¤ Worker â”‚
â”‚         â”‚      â”‚   #2   â”‚
â”‚         â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  Wait:  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Short  â”‚â—„â”€â”€â”€â”€â”€â”¤ Worker â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   #3   â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  Processing: 3 concurrent
  Load: Distributed âœ…âœ…âœ…
```

---

**Legend:**
- â–º = Database Operation
- â†’ = Data Flow
- â—„ = Poll/Pull
- âœ… = Success
- âŒ = Failure
- âš¡ = Fast/Optimized
